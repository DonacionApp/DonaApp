name: CI Backend (NestJS + PostgreSQL)

on:
  push:
    branches: [ "main", "144-backend-configurar-cd-de-backend" ]
  pull_request:
    branches: [ "main" ]
    paths:
      - 'backend/**'

jobs:
  check_backend_ci:
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ./backend

    env:
      POSTGRES_USER: ${{ vars.POSTGRES_USER }}
      POSTGRES_DB: ${{ vars.POSTGRES_DB }}
      DB_HOST: ${{ vars.DB_HOST }} 
      DB_PORT: ${{ vars.DB_PORT }}
      DB_USER: ${{ vars.DB_USER }}
      DB_NAME: ${{ vars.DB_NAME }}
      
      POSTGRES_PASSWORD: ${{ secrets.DB_PASSWORD }}
      DB_PASS: ${{ secrets.DB_PASSWORD }}
      
      DATABASE_URL: postgresql://${{ vars.POSTGRES_USER }}:${{ secrets.DB_PASSWORD }}@${{ vars.DB_HOST }}:${{ vars.DB_PORT }}/${{ vars.POSTGRES_DB }}
      
      JWT_SECRET: ${{ secrets.JWT_SECRET }}

    steps:
      - name: Checkout del código
        uses: actions/checkout@v4

      - name: Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Levantar PostgreSQL con Docker Compose
        run: |
          docker compose -f docker-compose-postgress.yml up -d
          docker ps

      - name: Esperar a que PostgreSQL esté listo
        run: |
          # Espera a que el contenedor de PostgreSQL esté listo antes de correr migraciones/pruebas
          until docker exec postgres_db pg_isready -U ${{ vars.POSTGRES_USER }}; do
            echo "Esperando a PostgreSQL..."
            sleep 3
          done

      - name: Instalar dependencias
        run: npm install

      - name: Compilar proyecto NestJS
        run: npm run build

      - name: Ejecutar Pruebas Unitarias/E2E
        run: npm run test:ci || npm run test

      - name: Detener contenedores
        if: always()
        run: docker compose -f docker-compose-postgress.yml down -v

      - name: Verificación final
        run: echo "CI Backend completado correctamente"

  deploy_if_passed:
    name: Llamar al CD (Despliegue)
    needs: check_backend_ci
    if: success() && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/144-backend-configurar-cd-de-backend')
    
    uses: ./.github/workflows/backend-cd.yml
    secrets:
      GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
      GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
      PROD_DB_HOST: ${{ secrets.PROD_DB_HOST }}
      PROD_DB_PORT: ${{ secrets.PROD_DB_PORT }}
      PROD_DB_USER: ${{ secrets.PROD_DB_USER }}
      PROD_DB_NAME: ${{ secrets.PROD_DB_NAME }}
      PROD_DB_PASSWORD: ${{ secrets.PROD_DB_PASSWORD }}

      APP_PORT: ${{ secrets.APP_PORT }}
      JWT_SECRET: ${{ secrets.JWT_SECRET }}
      JWT_EXPIRES_IN: ${{ secrets.JWT_EXPIRES_IN }}
      URL_COUNTRIES_API: ${{ secrets.URL_COUNTRIES_API }}
      API_KEY_COUNTRIES_API: ${{ secrets.API_KEY_COUNTRIES_API }}
      MAIL_HOST: ${{ secrets.MAIL_HOST }}
      MAIL_USER: ${{ secrets.MAIL_USER }}
      MAIL_PASSWORD: ${{ secrets.MAIL_PASSWORD }}
      MAIL_FROM: ${{ secrets.MAIL_FROM }}
      MAIL_PORT: ${{ secrets.MAIL_PORT }}
      URL_FRONTEND: ${{ secrets.URL_FRONTEND }}
      URL_FRONTEND_VERIFY_TOKEN: ${{ secrets.URL_FRONTEND_VERIFY_TOKEN }}
      URL_FRONTEND_VERIFY: ${{ secrets.URL_FRONTEND_VERIFY }}
      URL_FRONTEND_RESET_PASS_TOKEN: ${{ secrets.URL_FRONTEND_RESET_PASS_TOKEN }}
      CLOUDINARY_NAME: ${{ secrets.CLOUDINARY_NAME }}
      CLOUDINARY_API_KEY: ${{ secrets.CLOUDINARY_API_KEY }}
      CLOUDINARY_API_SECRET: ${{ secrets.CLOUDINARY_API_SECRET }}
      CLOUDINARY_FOLDER_BASE: ${{ secrets.CLOUDINARY_FOLDER_BASE }}
      CLOUDINARY_PROFILE_FOLDER: ${{ secrets.CLOUDINARY_PROFILE_FOLDER }}
      CLOUDINARY_POST_FOLDER: ${{ secrets.CLOUDINARY_POST_FOLDER }}
      CLOUDINARY_DOCS_FOLDER: ${{ secrets.CLOUDINARY_DOCS_FOLDER }}
      CLOUDINARY_CHATS_FOLDER: ${{ secrets.CLOUDINARY_CHATS_FOLDER }}
      CLOUDINARY_POSTS_FOLDER: ${{ secrets.CLOUDINARY_POSTS_FOLDER }}
      AWS_REGION: ${{ secrets.AWS_REGION }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      GEMINI_API_KEY_AUX: ${{ secrets.GEMINI_API_KEY_AUX }}
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      MICROSERVICONSENTIMENTS_URL: ${{ secrets.MICROSERVICONSENTIMENTS_URL }}
      MICROSERVICONSENTIMENTS_URL_AUX: ${{ secrets.MICROSERVICONSENTIMENTS_URL_AUX }}